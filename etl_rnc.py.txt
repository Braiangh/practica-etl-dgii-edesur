import pandas as pd
from sqlalchemy import create_engine, text  # <-- AquÃ­ agregamos 'text'

# --- 1. CONFIGURACIÃ“N (Pon tus datos de Aiven aquÃ­) ---
USER = ''
PASS = ''
HOST = ''
PORT = '15385'
DB   = 'defaultdb'

# Crear la conexiÃ³n
conexion_url = f"mysql+pymysql://{USER}:{PASS}@{HOST}:{PORT}/{DB}"
engine = create_engine(conexion_url)

def ejecutar_etl():
    archivo_csv = "rnc_dgii.csv" 
    
    try:
        print("ðŸš€ Preparando tabla con Primary Key en Aiven...")
        
        # 1. Crear la tabla manualmente primero
        with engine.connect() as con:
            # MySQL requiere el commit para confirmar cambios estructurales
            con.execute(text("DROP TABLE IF EXISTS rnc_contribuyentes"))
            con.execute(text("""
                CREATE TABLE rnc_contribuyentes (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    columna_1 VARCHAR(255),
                    columna_2 VARCHAR(255),
                    columna_3 VARCHAR(255),
                    columna_4 VARCHAR(255),
                    columna_5 VARCHAR(255),
                    columna_6 VARCHAR(255)
                )
            """))
            con.commit() # Confirmar la creaciÃ³n
        
        print("âœ… Tabla creada. Iniciando carga de datos...")

        # 2. Cargar los datos por bloques
        lector = pd.read_csv(
            archivo_csv, 
            sep=',', 
            encoding='latin-1', 
            header=0, 
            chunksize=50000
        )

        for i, bloque in enumerate(lector):
            # Forzamos los nombres de columnas para que coincidan con la tabla SQL
            # (ignorando el 'id' porque es autoincremental)
            bloque.columns = [f"columna_{j+1}" for j in range(len(bloque.columns))]
            
            # Cargamos usando 'append'
            bloque.to_sql('rnc_contribuyentes', con=engine, if_exists='append', index=False)
            print(f"ðŸ“¦ Bloque {i+1} cargado exitosamente...")

        print("\nâœ¨ Â¡Proceso completado con Ã©xito!")

    except Exception as e:
        print(f"âŒ OcurriÃ³ un error: {e}")

if __name__ == "__main__":

    ejecutar_etl()
